/**
 *  CRUD基本クラス | CrudBase.js
 * 
 * @desc
 * 管理画面を支援するクラスです。
 * 一覧の行、新規入力フォーム、編集フォームから値をエンティティの構造で取得したり、セットしたりできます。
 * 他に、管理画面でよく使われる機能を当クラスで集約して管理しています。
 * PHP側のCrudBaseパッケージとはCrudBaseDataを通して連動しています。
 * 
 * ------------------------------------------------------------------
 * 
 * 【CrudBaseの開発について】
 * 
 * CrudBaseの目的は管理画面の各種機能を支援することです。
 * あくまで支援なので当クラスが主役になるような設計は望ましくありません。
 * 一般的な管理画面でよく使われる機能を支援する形でサービスを提供します。
 * 
 * 当クラスはjQueryと依存していますが、Vue.jsや他のパッケージに依存した設計にしても保守的に問題ないです。
 * 
 * CrudBase.jsで各種モジュールを集約して管理しています。
 * 当クラスを通して各種モジュールにアクセスするようにしてください。
 * 
 * オーバーヘッドを減らしたいため、あまり使わないモジュールは初期化メソッドで実装しないようにしてください。
 * 使用頻度の低いモジュールはfactoryメソッドで対応してください。
 * 
 * 各所に散在するそれぞれのコールバックはフックで対応します。
 * このフックはWordpressプラグイン開発におけるフックと同じような概念になります。
 * 当クラスでは「hooks」として管理されます。
 * hooksに関数がセットされています。
 * 
 * @license MIT
 * @since 2016-9-21 | 2022-10-7
 * @version 4.0.0
 * @histroy
 * 2022-10-7 v4.0.0 保守性が悪い問題を解決するため大幅なリニューアルしました。使用頻度の低いモジュールを廃止し、保守性の高い設計にしています。フックの概念も導入。
 * 2019-6-28 v2.8.3 CSVフィールドデータ補助クラス | CsvFieldDataSupport.js
 * 2018-10-21 v2.8.0 ボタンサイズ変更機能にボタン表示切替機能を追加
 * 2018-10-21 v2.6.0 フォームをアコーディオン形式にする。
 * 2018-10-2 v2.5.0 フォームドラッグとリサイズ
 * 2018-9-18 v2.4.4 フォームフィット機能を追加
 * v2.0 CrudBase.jsに名称変更、およびES6に対応（IE11は非対応）
 * v1.7 WordPressに対応
 * 2016-9-21 v1.0.0
 * 
 */
class CrudBase{constructor(t,e,a){null==t&&(t={}),null==e&&(e=[]),null==a&&(a={}),this.crudBaseData=t,this.data=e,this.hooks=a;let r=t.h_tbl_xid,i=t.csrf_token;this.autoSave=new CrudBaseAutoSave(t.auto_save_xid,i),this.rowExchange=this.factoryRowExchange(r,e,t.auto_save_url,a.afterRowExchange,a.afterAutoSave),this.showModalBigImg=new ShowModalBigImg(".js_show_modal_big_img")}factoryRowExchange(t,e,a,r,i){if(this.rowExchange)return this.rowExchange;return new RowExchange(t,e,null,(t=>{r&&r(t),autoSave.saveRequest(t.data,a,(()=>{i&&i(t)}))}))}}class CrudBaseAutoSave{constructor(t,e){this.msgElm=jQuery("#"+t),this.data,this.set_timeout_hdl,this.csrf_token=e}saveRequest(t,e,a,r){this.data=t,this.auto_save_url=e,this.afterCallBack=a,null==r&&(r={}),null==r.interval&&(r.interval=3e3),this.option=r,null!=this.set_timeout_hdl&&clearTimeout(this.set_timeout_hdl),this.set_timeout_hdl=setTimeout((()=>{this._autoSave(this.data)}),r.interval)}_autoSave(t){this.msgElm.html("保存中..."),t=this._escapeForAjax(t);let e=JSON.stringify(t),a=this.auto_save_url,r=new FormData;r.append("key1",e),r.append("_token",this.csrf_token),jQuery.ajax({type:"post",url:a,data:r,cache:!1,dataType:"text",processData:!1,contentType:!1}).done(((t,e)=>{let a;try{a=jQuery.parseJSON(t),this.msgElm.html("")}catch(e){return this.msgElm.html("自動保存のエラー1"),void jQuery("#err").html(t)}this.afterCallBack&&this.afterCallBack()})).fail(((t,e,a)=>{this.msgElm.html("自動保存のエラー"),console.log(t),jQuery("#err").html(t.responseText)}))}_escapeForAjax(t){if("string"==typeof t)return-1!=t.indexOf("&")?(t=t.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),encodeURIComponent(t)):t;if("object"==typeof t){for(var e in t)t[e]=this._escapeForAjax(t[e]);return t}return t}}
/**
 * 
 * 行入替機能
 * 
 * @note
 * テーブルの行を入れ替えることによる並べ替え
 * 
 * @version 2.0.0 Bootstrap4に対応
 * @since 2017-3-7 | 2022-7-8
 * @license MIT
 * 
 */class RowExchange{constructor(t,e,a,r){null==a&&(a={}),this.afterCallback=r,this.tbl=a.jqTbl,null==this.tbl&&(this.tbl=jQuery("#"+t)),this.data=e;var i="#exchange_tr_form_"+t;a.form_slt=i;var s=this._getFormHtml(i);this.tbl.after(s),this.form=jQuery(i),this.param=a,this.form.find(".exchange_tr_form_close").click((()=>{this.form.hide()})),this.form.find(".exchange_tr_btn").click((()=>{this._exchageTrReb()})),jQuery(i+" input").keypress((t=>{13==t.which&&this._exchageTrReb()})),this.form.find(".exchange_tr_shift_up").click((()=>{this._exchageTrShiftUp()})),this.form.find(".exchange_tr_shift_down").click((()=>{this._exchageTrShiftDown()}))}showForm(t){var e=jQuery(t),a=e.parents("tr").index();a+=1,this.param.from_row_index=a;var r=this.form.find(".exchange_tr_sort_no"),i=r.val();this._empty(i)&&r.val(a),this._showForm(this.form,e)}_exchageTrReb(){var t=this.param.from_row_index,e=this.form.find(".exchange_tr_sort_no").val();0!=this._checkRowIndex(e)&&t!=e&&this._exchageTr(t,e)}_exchageTrShiftUp(){var t=this.param.from_row_index,e=t-1;e<=0||(this._exchageTr(t,e),this.param.from_row_index=e)}_exchageTrShiftDown(){var t=this.param.from_row_index,e=t+1;e>this.tbl.children("tbody").children("tr").length||(this._exchageTr(t,e),this.param.from_row_index=e)}_exchageTr(t,e){var a=this.tbl.find("tr").eq(t),r=this.tbl.find("tr").eq(e);t>e?jQuery(r).before(a):jQuery(r).after(a);let i=t-1,s=e-1,o=this.data[i].sort_no,n=this.data[s].sort_no;this.data[i].sort_no=n,this.data[s].sort_no=o,this.data=this._swapElementsOfArray(this.data,i,s),this.afterCallback&&this.afterCallback({from_row_index:t,to_row_index:e,from_index:i,to_index:s,data:this.data})}_swapElementsOfArray(t,e,a){if(e<0)throw Error("Error:220710A");if(e>=t.length)throw Error("Error:220710B");if(a<0)throw Error("Error:220710C");if(a>=t.length)throw Error("Error:220710D");let r=[],i=t[e],s=t[a];for(let o in t)o==e?r.push(s):o==a?r.push(i):r.push(t[o]);return r}_checkRowIndex(t){return null!=t&&(!!t.match(/^[0-9]*$/)&&!(t<=0))}_showForm(t,e,a){a||(a="auto"),t.show();var r=(e=jQuery(e)).offset(),i=r.left,s=r.top,o=jQuery(window).width(),n=t.outerWidth(),h=s+e.outerHeight(),l=0;switch(a){case"left":l=i-n;break;case"center":l=o/2-n/2;break;case"right":l=i;break;default:(l=i)+n>o&&(l=o-n)}l<0&&(l=0),t.offset({top:h,left:l})}_getFormHtml(t){var e=this._sltToCode(t);return"<div id='"+e+"_rap'>\t<div id='"+e+"' class='card' style='display:none;width:200px;background-color:white'>\t\t<div class='card-header bg-primary'>\t\t\t\t\t\t<div class='text-light' style='display:inline-block;width:60%'>行入替</div>\t\t\t<div class='text-light' style='display:inline-block;width:35%;text-align:right'>\t\t\t\t<button type='button' class='exchange_tr_form_close btn btn-primary btn-sm'  aria-label='閉じる'>\t\t\t\t\t<span class='oi' data-glyph='x'></span>\t\t\t\t</button>\t\t\t</div>\t\t</div>\t\t<div class='card-body' \">\t\t\t<button type='button' class='exchange_tr_shift_up btn btn-primary btn-sm' style='font-weight:bold;' title='一つ上に移動します。'><span class='oi' data-glyph='arrow-thick-top'></span></button>\t\t\t<button type='button' class='exchange_tr_shift_down btn btn-primary btn-sm' style='font-weight:bold;' title='一つ下に移動します。'><span class='oi' data-glyph='arrow-thick-bottom'></span></button>\t\t\t<div style='margin-top:20px'>\t\t\t\t<input class='exchange_tr_sort_no' type='number' style='width:60px' min='1' max='9999'  title='移動したい行の位置を数値で入力してください。先頭に移動させたい場合は1を入力して行入替ボタンを押します。上から3番目に移動させたい場合は3を入力します。' />\t\t\t\t<input type='button' value='行入替' class='exchange_tr_btn btn btn-warning btn-sm' />\t\t\t</div>\t\t</div>\t</div></div>"}_sltToCode(t){var e=t,a=e.charAt(0);return"#"!=a&&"."!=a||(e=e.substr(1)),e}_empty(t){return null==t||""==t||"0"==t||"object"==typeof t&&0==Object.keys(t).length}}class ShowModalBigImg{constructor(t){this.modalCat=this._createModalDiv();let e=this.modalCat.getContent();this.mdlImgElm=e.find("img"),this.jqElm=jQuery(t),this.jqElm.click((t=>{let e=$(t.currentTarget);return this._onClick(e),!1}))}_createModalDiv(){jQuery("body").prepend('<div id="show_modal_big_img_mdl" ><img src="" alt="" style="max-width:100%" /></div>');let t=new ModalCat_smbi;return t.modalize("show_modal_big_img_mdl"),t}_onClick(t){let e=t.attr("href");console.log("orig_img_url="+e);let a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="blob",a.onload=t=>{var a=t.target.response,r=window.URL.createObjectURL(a);this.mdlImgElm.attr("src",r),this.modalCat.open(),console.log(e)},a.send()}}
/**
 * モーダル化クラス
 * @since 2022-1-21
 * @version 1.0.0
 * @auther amaraimusi
 * @license MIT
 */class ModalCat_smbi{modalize(t){let e=t+"_js_main",a=t+"_js_modal_close",r=jQuery("#"+t);r.wrap(`<div id='${e}'></div>`);let i=jQuery("#"+e),s=`<div id='${a}'></div>`;i.prepend(s);let o=jQuery(i.find("#"+a));i.css({display:"none",height:"100vh",position:"fixed",top:"0",left:"0",width:"100vw"}),o.css({background:"rgba(0,0,0,0.8)",height:"100vh",position:"absolute",width:"100vw"}),r.css({background:"#fff",left:"50%",padding:"10px",position:"absolute",top:"50%",transform:"translate(-50%,-50%)",width:"60%"}),this.main=i,this.content=r,o.on("click",(()=>(this.main.fadeOut(),!1)))}open(){this.main.fadeIn()}close(){this.main.fadeOut()}getMainDiv(){return this.main}getContent(){return this.content}}